// @version=5
indicator("Market Structure [Pivot Based]", overlay=true, max_lines_count=500, max_labels_count=500, max_bars_back=5000)

// -----------------------------------------------------------------------------
// CÁC THAM SỐ ĐẦU VÀO (INPUTS)
// -----------------------------------------------------------------------------
grp_settings = "Cài đặt ZigZag"
lengthLeft = input.int(5, "Số nến bên trái Pivot", minval=1, group=grp_settings)
lengthRight = input.int(5, "Số nến bên phải Pivot", minval=1, group=grp_settings)

grp_visual = "Cài đặt Hiển thị"
showZigZag = input.bool(true, "Hiển thị đường ZigZag", group=grp_visual)

grp_structure = "Cài đặt Cấu trúc (BOS/CHOCH)"
showBOS = input.bool(true, "Hiển thị BOS", group=grp_structure)
showCHOCH = input.bool(true, "Hiển thị CHOCH", group=grp_structure)
lblSize = input.string(size.small, "Kích thước Nhãn", options=[size.tiny, size.small, size.normal, size.large], group=grp_structure)

// -----------------------------------------------------------------------------
// BIẾN VÀ KIỂU DỮ LIỆU
// -----------------------------------------------------------------------------
var int direction = 0 
var float lastHigh = na
var float lastLow = na
var int lastHighIndex = na 
var int lastLowIndex = na

// Arrays to store history of completed swings
var float[] swingHighs = array.new_float()
var int[] swingHighIndices = array.new_int()
var float[] swingLows = array.new_float()
var int[] swingLowIndices = array.new_int()

var line zigzagLine = na
var label currentLabel = na 

// -----------------------------------------------------------------------------
// LOGIC: ZIGZAG
// -----------------------------------------------------------------------------
ph = ta.pivothigh(high, lengthLeft, lengthRight)
pl = ta.pivotlow(low, lengthLeft, lengthRight)

pivotIndex = bar_index - lengthRight

if not na(ph)
    if direction == 0
        direction := 1
        lastHigh := ph
        lastHighIndex := pivotIndex
        if showZigZag
            zigzagLine := line.new(lastHighIndex, ph, lastHighIndex, ph, color=color.blue, width=2)
            currentLabel := label.new(lastHighIndex, lastHigh, str.tostring(lastHigh, format.mintick), color=color.green, style=label.style_label_down, textcolor=color.white, size=size.small)

    else if direction == 1 
        // Making Higher High?
        if ph > lastHigh
            lastHigh := ph
            lastHighIndex := pivotIndex
            if showZigZag
                line.set_xy2(zigzagLine, lastHighIndex, lastHigh)
                label.set_xy(currentLabel, lastHighIndex, lastHigh)
                label.set_text(currentLabel, str.tostring(lastHigh, format.mintick))
                
    else 
        // Switch to Uptrend
        direction := 1
        lastHigh := ph
        lastHighIndex := pivotIndex
        
        array.push(swingHighs, lastHigh)
        array.push(swingHighIndices, lastHighIndex)

        if showZigZag
            zigzagLine := line.new(lastLowIndex, lastLow, lastHighIndex, lastHigh, color=color.blue, width=2)
            currentLabel := label.new(lastHighIndex, lastHigh, str.tostring(lastHigh, format.mintick), color=color.green, style=label.style_label_down, textcolor=color.white, size=size.small)

if not na(pl)
    if direction == 0
        direction := -1
        lastLow := pl
        lastLowIndex := pivotIndex
        if showZigZag
            zigzagLine := line.new(lastLowIndex, pl, lastLowIndex, pl, color=color.blue, width=2)
            currentLabel := label.new(lastLowIndex, lastLow, str.tostring(lastLow, format.mintick), color=color.red, style=label.style_label_up, textcolor=color.white, size=size.small)

    else if direction == -1 
        // Making Lower Low?
        if pl < lastLow 
            lastLow := pl
            lastLowIndex := pivotIndex
            if showZigZag
                line.set_xy2(zigzagLine, lastLowIndex, lastLow)
                label.set_xy(currentLabel, lastLowIndex, lastLow)
                label.set_text(currentLabel, str.tostring(lastLow, format.mintick))
    
    else 
        // Switch to Downtrend
        direction := -1
        lastLow := pl
        lastLowIndex := pivotIndex
        
        array.push(swingLows, lastLow)
        array.push(swingLowIndices, lastLowIndex)

        if showZigZag
            zigzagLine := line.new(lastHighIndex, lastHigh, lastLowIndex, lastLow, color=color.blue, width=2)
            currentLabel := label.new(lastLowIndex, lastLow, str.tostring(lastLow, format.mintick), color=color.red, style=label.style_label_up, textcolor=color.white, size=size.small)

// -----------------------------------------------------------------------------
// BOS / CHOCH DETECTION
// -----------------------------------------------------------------------------
// Chỉ hiển thị khi giá đóng cửa phá vỡ lastHighIndex hoặc lastLowIndex (trong mảng swing)

var int lastBrokenHighIdx = 0
var int lastBrokenLowIdx = 0

// Current Bar Close
currentClose = close
currentIndex = bar_index

// Check Break of Structure High
if array.size(swingHighs) > 0
    // Get the Last Confirmed Swing High from history
    float targetHigh = array.get(swingHighs, array.size(swingHighs)-1)
    int targetHighIdx = array.get(swingHighIndices, array.size(swingHighIndices)-1)

    // CHECK: Close price breaks the targetHigh AND we haven't marked this specific high as broken yet
    if currentClose > targetHigh and targetHighIdx != lastBrokenHighIdx
        string txt = "BOS"
        // Determine BOS vs CHOCH
        if array.size(swingHighs) > 1
             if targetHigh < array.get(swingHighs, array.size(swingHighs)-2)
                txt := "CHOCH"
        
        if (txt == "BOS" and showBOS) or (txt == "CHOCH" and showCHOCH)
            // Color Green (Bullish Break)
            line.new(targetHighIdx, targetHigh, currentIndex, targetHigh, color=color.green, style=line.style_solid, width=1)
            label.new(currentIndex, targetHigh, txt, color=color.green, style=label.style_label_down, textcolor=color.white, size=lblSize)
            
            // Mark as broken so we don't draw multiple times for the same swing
            lastBrokenHighIdx := targetHighIdx

// Check Break of Structure Low
if array.size(swingLows) > 0
    // Get the Last Confirmed Swing Low from history
    float targetLow = array.get(swingLows, array.size(swingLows)-1)
    int targetLowIdx = array.get(swingLowIndices, array.size(swingLowIndices)-1)

    // CHECK: Close price breaks the targetLow AND we haven't marked this specific low as broken yet
    if currentClose < targetLow and targetLowIdx != lastBrokenLowIdx
        string txt = "BOS"
        if array.size(swingLows) > 1
            if targetLow > array.get(swingLows, array.size(swingLows)-2)
                txt := "CHOCH"

        if (txt == "BOS" and showBOS) or (txt == "CHOCH" and showCHOCH)
            // Color Red (Bearish Break)
            line.new(targetLowIdx, targetLow, currentIndex, targetLow, color=color.red, style=line.style_solid, width=1)
            label.new(currentIndex, targetLow, txt, color=color.red, style=label.style_label_up, textcolor=color.white, size=lblSize)
            
            lastBrokenLowIdx := targetLowIdx