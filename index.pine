// @version=5
indicator("Market Structure [Pivot Based]", overlay=true, max_lines_count=500, max_labels_count=500, max_bars_back=5000)

// -----------------------------------------------------------------------------
// CÁC THAM SỐ ĐẦU VÀO (INPUTS)
// -----------------------------------------------------------------------------
grp_settings = "Cài đặt ZigZag"
lengthLeft = input.int(5, "Số nến bên trái Pivot", minval=1, group=grp_settings)
lengthRight = input.int(5, "Số nến bên phải Pivot", minval=1, group=grp_settings)

grp_visual = "Cài đặt Hiển thị"
colorUp = input.color(color.green, "Màu Xu hướng Tăng", group=grp_visual)
colorDown = input.color(color.red, "Màu Xu hướng Giảm", group=grp_visual)
lineWidth = input.int(2, "Độ dày đường ZigZag", minval=1, group=grp_visual)
showZigZag = input.bool(true, "Hiển thị đường ZigZag", group=grp_visual)

grp_structure = "Cài đặt Cấu trúc (BOS/CHOCH)"
showBOS = input.bool(true, "Hiển thị BOS", group=grp_structure)
showCHOCH = input.bool(true, "Hiển thị CHOCH", group=grp_structure)
colorBOS = input.color(color.blue, "Màu BOS", group=grp_structure)
colorCHOCH = input.color(color.orange, "Màu CHOCH", group=grp_structure)
lblSize = input.string(size.small, "Kích thước Nhãn", options=[size.tiny, size.small, size.normal, size.large], group=grp_structure)

// -----------------------------------------------------------------------------
// BIẾN VÀ KIỂU DỮ LIỆU
// -----------------------------------------------------------------------------
// Theo dõi hướng hiện tại và các điểm Đỉnh/Đáy gần nhất
// Direction: 1 = Xu hướng tăng (đang tìm đỉnh), -1 = Xu hướng giảm (đang tìm đáy)
var int direction = 0 
// Các điểm Pivot đã xác nhận gần nhất
var float lastHigh = na
var float lastLow = na
var int lastHighIndex = na
var int lastLowIndex = na

// Mảng lưu trữ các điểm swing để phân tích cấu trúc thị trường
// Chúng ta cần lưu lịch sử để xác định sự phá vỡ cấu trúc (Break of Structure)
var float[] swingHighs = array.new_float()
var int[] swingHighIndices = array.new_int()
var float[] swingLows = array.new_float()
var int[] swingLowIndices = array.new_int()

// Biến lưu đường ZigZag hiện tại đang vẽ
var line zigzagLine = na

// -----------------------------------------------------------------------------
// TÍNH TOÁN PIVOT (ĐỈNH/ĐÁY)
// -----------------------------------------------------------------------------
// Tìm điểm Pivot High và Pivot Low dựa trên số nến trái/phải
ph = ta.pivothigh(high, lengthLeft, lengthRight)
pl = ta.pivotlow(low, lengthLeft, lengthRight)

// -----------------------------------------------------------------------------
// LOGIC: ZIGZAG VÀ CẤU TRÚC THỊ TRƯỜNG
// -----------------------------------------------------------------------------
// Khi tìm thấy một Pivot High (Đỉnh) mới
if not na(ph)
    // Nếu chưa xác định hướng (lần chạy đầu tiên)
    if direction == 0
        direction := 1
        lastHigh := ph
        lastHighIndex := bar_index - lengthRight
        if showZigZag
            zigzagLine := line.new(bar_index - lengthRight, ph, bar_index - lengthRight, ph, color=colorUp, width=lineWidth)

    // Nếu đang trong xu hướng tăng (đang tìm đỉnh)
    else if direction == 1 
        // Nếu đỉnh mới này cao hơn đỉnh "tạm thời" trước đó trong cùng con sóng tăng
        // Cập nhật lại đỉnh cao nhất của sóng hiện tại
        if ph > lastHigh
            lastHigh := ph
            lastHighIndex := bar_index - lengthRight
            if showZigZag
                line.set_xy2(zigzagLine, lastHighIndex, lastHigh)
                
    // Nếu đang trong xu hướng giảm (đang tìm đáy) -> Tìm thấy Đỉnh nghĩa là đảo chiều sang Tăng
    else 
        direction := 1
        lastHigh := ph
        lastHighIndex := bar_index - lengthRight
        
        // Lưu đỉnh vừa xác nhận vào mảng
        array.push(swingHighs, lastHigh)
        array.push(swingHighIndices, lastHighIndex)

        // Vẽ đường nối từ Đáy cũ lên Đỉnh mới vừa tìm thấy
        if showZigZag
            zigzagLine := line.new(lastLowIndex, lastLow, lastHighIndex, lastHigh, color=colorUp, width=lineWidth)

// Khi tìm thấy một Pivot Low (Đáy) mới
if not na(pl)
    // Khởi tạo lần đầu
    if direction == 0
        direction := -1
        lastLow := pl
        lastLowIndex := bar_index - lengthRight
        if showZigZag
            zigzagLine := line.new(bar_index - lengthRight, pl, bar_index - lengthRight, pl, color=colorDown, width=lineWidth)

    // Nếu đang trong xu hướng giảm (đang tìm đáy)
    else if direction == -1 
        // Nếu đáy mới thấp hơn đáy "tạm thời", cập nhật lại đáy thấp nhất
        if pl < lastLow 
            lastLow := pl
            lastLowIndex := bar_index - lengthRight
            if showZigZag
                line.set_xy2(zigzagLine, lastLowIndex, lastLow)
    
    // Nếu đang trong xu hướng tăng -> Tìm thấy Đáy nghĩa là đảo chiều sang Giảm
    else 
        direction := -1
        lastLow := pl
        lastLowIndex := bar_index - lengthRight
        
        // Lưu đáy vừa xác nhận vào mảng
        array.push(swingLows, lastLow)
        array.push(swingLowIndices, lastLowIndex)

        // Vẽ đường nối từ Đỉnh cũ xuống Đáy mới
        if showZigZag
            zigzagLine := line.new(lastHighIndex, lastHigh, lastLowIndex, lastLow, color=colorDown, width=lineWidth)

// -----------------------------------------------------------------------------
// XÁC ĐỊNH BOS VÀ CHOCH (PHÁ VỠ CẤU TRÚC)
// -----------------------------------------------------------------------------
// Kiểm tra sự phá vỡ cấu trúc trên mỗi thanh nến
// Sử dụng các điểm Swing High/Low đã HOÀN THÀNH gần nhất để so sánh

var bool bosUpDetected = false
var bool bosDownDetected = false
var int lastBrokenHighIndex = 0
var int lastBrokenLowIndex = 0

if array.size(swingHighs) > 0 and array.size(swingLows) > 0
    // Lấy Đỉnh và Đáy hoàn thành gần nhất
    float prevHigh = array.get(swingHighs, array.size(swingHighs)-1)
    int prevHighIdx = array.get(swingHighIndices, array.size(swingHighIndices)-1)
    
    float prevLow = array.get(swingLows, array.size(swingLows)-1)
    int prevLowIdx = array.get(swingLowIndices, array.size(swingLowIndices)-1)

    // --- XU HƯỚNG TĂNG (BULLISH BREAK) ---
    // Điều kiện: Giá đóng cửa vượt qua Đỉnh cũ gần nhất
    // Kiểm tra xem Đỉnh này đã bị đánh dấu phá vỡ chưa (để tránh vẽ lại nhiều lần)
    
    bool isBullCase = close > prevHigh
    bool isBearCase = close < prevLow
    
    // Xử lý phá vỡ Đỉnh (BOS Tăng hoặc CHOCH Tăng)
    if isBullCase and prevHighIdx != lastBrokenHighIndex
        string txt = "BOS"
        color col = colorBOS
        
        // Logic xác định CHOCH:
        // Nếu Đỉnh cũ thấp hơn Đỉnh trước đó nữa -> Tức là trước đó đang cấu trúc giảm (LH) -> Phá vỡ này là Đảo chiều (CHOCH)
        if array.size(swingHighs) > 1
            float prevPrevHigh = array.get(swingHighs, array.size(swingHighs)-2)
            if prevHigh < prevPrevHigh
                txt := "CHOCH"
                col := colorCHOCH
        
        if (txt == "BOS" and showBOS) or (txt == "CHOCH" and showCHOCH)
            // Vẽ đường phá vỡ Nét liền (Solid) vì đóng cửa nến đã vượt qua
            line.new(prevHighIdx, prevHigh, bar_index, prevHigh, color=col, style=line.style_solid, width=1)
            label.new(bar_index, prevHigh, txt, color=color.new(color.white, 100), style=label.style_label_down, textcolor=col, size=lblSize)
            
            lastBrokenHighIndex := prevHighIdx

    // Xử lý phá vỡ Đáy (BOS Giảm hoặc CHOCH Giảm)
    if isBearCase and prevLowIdx != lastBrokenLowIndex
        string txt = "BOS"
        color col = colorBOS
        
        // Logic xác định CHOCH:
        // Nếu Đáy cũ cao hơn Đáy trước đó nữa -> Tức là trước đó đang cấu trúc tăng (HL) -> Phá vỡ này là Đảo chiều (CHOCH)
        if array.size(swingLows) > 1
            float prevPrevLow = array.get(swingLows, array.size(swingLows)-2)
            if prevLow > prevPrevLow
                txt := "CHOCH"
                col := colorCHOCH

        if (txt == "BOS" and showBOS) or (txt == "CHOCH" and showCHOCH)
            // Vẽ đường phá vỡ Nét liền (Solid)
            line.new(prevLowIdx, prevLow, bar_index, prevLow, color=col, style=line.style_solid, width=1)
            label.new(bar_index, prevLow, txt, color=color.new(color.white, 100), style=label.style_label_up, textcolor=col, size=lblSize)
            
            lastBrokenLowIndex := prevLowIdx

// -----------------------------------------------------------------------------
// PHÁT HIỆN PHÁ VỠ BẰNG RÂU NẾN (WICK BREAK) - "WEAK BREAK"
// -----------------------------------------------------------------------------
// Yêu cầu: Nếu giá chỉ phá qua bằng râu (High/Low) nhưng đóng cửa vẫn nằm trong phạm vi -> Vẽ nét đứt (Dashed)

if array.size(swingHighs) > 0
    float prevHigh = array.get(swingHighs, array.size(swingHighs)-1)
    int prevHighIdx = array.get(swingHighIndices, array.size(swingHighIndices)-1)

    // Nếu High vượt qua Đỉnh cũ NHƯNG Close vẫn thấp hơn hoặc bằng (chưa phá hẳn) VÀ chưa bị đánh dấu phá vỡ
    if high > prevHigh and close <= prevHigh and prevHighIdx != lastBrokenHighIndex
        string txt = "BOS"
        color col = colorBOS
        
        if array.size(swingHighs) > 1
            if prevHigh < array.get(swingHighs, array.size(swingHighs)-2)
                txt := "CHOCH"
                col := colorCHOCH

        if (txt == "BOS" and showBOS) or (txt == "CHOCH" and showCHOCH)
            // Vẽ đường nét đứt (Dashed)
            line.new(prevHighIdx, prevHigh, bar_index, prevHigh, color=col, style=line.style_dashed, width=1)
            // Lưu ý: Không cập nhật lastBrokenHighIndex ở đây

if array.size(swingLows) > 0
    float prevLow = array.get(swingLows, array.size(swingLows)-1)
    int prevLowIdx = array.get(swingLowIndices, array.size(swingLowIndices)-1)

    // Nếu Low thấp hơn Đáy cũ NHƯNG Close vẫn cao hơn hoặc bằng
    if low < prevLow and close >= prevLow and prevLowIdx != lastBrokenLowIndex
        string txt = "BOS"
        color col = colorBOS
        
        if array.size(swingLows) > 1
            if prevLow > array.get(swingLows, array.size(swingLows)-2)
                txt := "CHOCH"
                col := colorCHOCH
        
        if (txt == "BOS" and showBOS) or (txt == "CHOCH" and showCHOCH)
            // Vẽ đường nét đứt (Dashed)
            line.new(prevLowIdx, prevLow, bar_index, prevLow, color=col, style=line.style_dashed, width=1)