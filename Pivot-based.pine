// @version=5
indicator("Market Structure [Pivot Based]", overlay=true, max_lines_count=500, max_labels_count=500, max_bars_back=5000, explicit_plot_zorder=true)

// -----------------------------------------------------------------------------
// HELPER: GET HIGHER TIMEFRAME
// -----------------------------------------------------------------------------
getHigherTF(tf) =>
    float tfInMin = timeframe.in_seconds(tf) / 60
    string res = "D" 
    if tfInMin < 5
        res := "5"
    else if tfInMin < 15
        res := "15"
    else if tfInMin < 60
        res := "60"
    else if tfInMin < 240
        res := "240"
    else if tfInMin < 1440
        res := "D"
    else if tfInMin < 10080
        res := "W"
    else 
        res := "M"
    res

// -----------------------------------------------------------------------------
// CÁC THAM SỐ ĐẦU VÀO (INPUTS)
// -----------------------------------------------------------------------------
grp_settings = "Cài đặt ZigZag"
lengthLeft = input.int(5, "Số nến bên trái Pivot", minval=1, group=grp_settings)
lengthRight = input.int(5, "Số nến bên phải Pivot", minval=1, group=grp_settings)

grp_visual = "Cài đặt Hiển thị"
showZigZag = input.bool(true, "Hiển thị đường ZigZag", group=grp_visual)

grp_structure = "Cài đặt Cấu trúc (BOS/CHOCH)"
showBOS = input.bool(true, "Hiển thị BOS", group=grp_structure)
showCHOCH = input.bool(true, "Hiển thị CHOCH", group=grp_structure)

// -----------------------------------------------------------------------------
// HTF DATA
// -----------------------------------------------------------------------------
htf = getHigherTF(timeframe.period)
htfBullish = request.security(syminfo.tickerid, htf, close >= open)

// -----------------------------------------------------------------------------
// BIẾN VÀ KIỂU DỮ LIỆU
// -----------------------------------------------------------------------------
var int direction = 0 
var float lastHigh = na
var float lastLow = na
var int lastHighIndex = na 
var int lastLowIndex = na

// Arrays to store history of completed swings
var float[] swingHighs = array.new_float()
var int[] swingHighIndices = array.new_int()
var float[] swingLows = array.new_float()
var int[] swingLowIndices = array.new_int()

var line zigzagLine = na
var label currentLabel = na 

// -----------------------------------------------------------------------------
// LOGIC: ZIGZAG
// -----------------------------------------------------------------------------
ph = ta.pivothigh(high, lengthLeft, lengthRight)
pl = ta.pivotlow(low, lengthLeft, lengthRight)

pivotIndex = bar_index - lengthRight

// Determine HTF Status AT THE TIME OF PIVOT (approximate)
isHtfBull = htfBullish[lengthRight]

if not na(ph)
    // --- FOUND PIVOT HIGH ---
    if direction == 0
        direction := 1
        lastHigh := ph
        lastHighIndex := pivotIndex
        // Init (Undefined)
        if showZigZag
            zigzagLine := line.new(lastHighIndex, ph, lastHighIndex, ph, color=color.blue, width=2)
            currentLabel := label.new(lastHighIndex, lastHigh, str.tostring(lastHigh, format.mintick), color=color.green, style=label.style_label_down, textcolor=color.white, size=size.small)

    else if direction == 1 
        // --- UPTREND EXTENSION ---
        if ph > lastHigh
            lastHigh := ph
            lastHighIndex := pivotIndex
            if showZigZag
                line.set_xy2(zigzagLine, lastHighIndex, lastHigh)
                label.set_xy(currentLabel, lastHighIndex, lastHigh)
                label.set_text(currentLabel, str.tostring(lastHigh, format.mintick))
                
                // Update Width Live
                // Leg Direction: UP. HTF: Bullish?
                _width = isHtfBull ? 5 : 2
                line.set_width(zigzagLine, _width)
                
    else 
        // --- SWITCH TO UPTREND ---
        direction := 1
        lastHigh := ph
        lastHighIndex := pivotIndex
        
        array.push(swingHighs, lastHigh)
        array.push(swingHighIndices, lastHighIndex)

        if showZigZag
            // Draw Line from LAST LOW to THIS HIGH (Up Wave)
            // Leg Direction: UP. HTF: Bullish?
            _width = isHtfBull ? 5 : 2
            zigzagLine := line.new(lastLowIndex, lastLow, lastHighIndex, lastHigh, color=color.blue, width=_width)
            currentLabel := label.new(lastHighIndex, lastHigh, str.tostring(lastHigh, format.mintick), color=color.green, style=label.style_label_down, textcolor=color.white, size=size.small)

if not na(pl)
    // --- FOUND PIVOT LOW ---
    if direction == 0
        direction := -1
        lastLow := pl
        lastLowIndex := pivotIndex
        if showZigZag
            zigzagLine := line.new(lastLowIndex, pl, lastLowIndex, pl, color=color.blue, width=2)
            currentLabel := label.new(lastLowIndex, lastLow, str.tostring(lastLow, format.mintick), color=color.red, style=label.style_label_up, textcolor=color.white, size=size.small)

    else if direction == -1 
        // --- DOWNTREND EXTENSION ---
        if pl < lastLow 
            lastLow := pl
            lastLowIndex := pivotIndex
            if showZigZag
                line.set_xy2(zigzagLine, lastLowIndex, lastLow)
                label.set_xy(currentLabel, lastLowIndex, lastLow)
                label.set_text(currentLabel, str.tostring(lastLow, format.mintick))
                
                // Update Width Live
                // Leg Direction: DOWN. HTF: Bearish? (not htfBullish)
                _width = (not isHtfBull) ? 5 : 2
                line.set_width(zigzagLine, _width)
    
    else 
        // --- SWITCH TO DOWNTREND ---
        direction := -1
        lastLow := pl
        lastLowIndex := pivotIndex
        
        array.push(swingLows, lastLow)
        array.push(swingLowIndices, lastLowIndex)

        if showZigZag
            // Draw Line from LAST HIGH to THIS LOW (Down Wave)
            // Leg Direction: DOWN. HTF: Bearish?
            _width = (not isHtfBull) ? 5 : 2
            zigzagLine := line.new(lastHighIndex, lastHigh, lastLowIndex, lastLow, color=color.blue, width=_width)
            currentLabel := label.new(lastLowIndex, lastLow, str.tostring(lastLow, format.mintick), color=color.red, style=label.style_label_up, textcolor=color.white, size=size.small)

// -----------------------------------------------------------------------------
// BOS / CHOCH DETECTION
// -----------------------------------------------------------------------------
var int lastBrokenHighIdx = 0
var int lastBrokenLowIdx = 0

// Current Bar Close
currentClose = close
currentIndex = bar_index

if array.size(swingHighs) > 0
    float targetHigh = array.get(swingHighs, array.size(swingHighs)-1)
    int targetHighIdx = array.get(swingHighIndices, array.size(swingHighIndices)-1)

    if currentClose > targetHigh and targetHighIdx != lastBrokenHighIdx
        string txt = "BOS"
        color col = color.blue // Default BOS color

        if array.size(swingHighs) > 1
            if targetHigh < array.get(swingHighs, array.size(swingHighs)-2)
                txt := "CHOCH"
                col := color.orange // CHOCH color
        
        if (txt == "BOS" and showBOS) or (txt == "CHOCH" and showCHOCH)
            line.new(targetHighIdx, targetHigh, currentIndex, targetHigh, color=col, style=line.style_dashed, width=2)
            label.new(currentIndex, targetHigh, txt, color=col, style=label.style_label_down, textcolor=color.white, size=size.small)
            
            lastBrokenHighIdx := targetHighIdx

if array.size(swingLows) > 0
    float targetLow = array.get(swingLows, array.size(swingLows)-1)
    int targetLowIdx = array.get(swingLowIndices, array.size(swingLowIndices)-1)

    if currentClose < targetLow and targetLowIdx != lastBrokenLowIdx
        string txt = "BOS"
        color col = color.blue // Default BOS color

        if array.size(swingLows) > 1
            if targetLow > array.get(swingLows, array.size(swingLows)-2)
                txt := "CHOCH"
                col := color.orange // CHOCH color

        if (txt == "BOS" and showBOS) or (txt == "CHOCH" and showCHOCH)
            line.new(targetLowIdx, targetLow, currentIndex, targetLow, color=col, style=line.style_dashed, width=2)
            label.new(currentIndex, targetLow, txt, color=col, style=label.style_label_up, textcolor=color.white, size=size.small)
            
            lastBrokenLowIdx := targetLowIdx